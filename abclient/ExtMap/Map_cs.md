# Анализ Map.cs

**Расположение:** `abclient/ExtMap/Map.cs`

**Назначение:**
Класс `Map` является центральным компонентом для управления данными карты в приложении ABClient. Он хранит информацию о местоположениях, ячейках, телепортах и обеспечивает вспомогательные функции для работы с картой.

**Ключевые особенности:**

*   **`Location (SortedDictionary<string, Position>)`:** Словарь, сопоставляющий строковое представление координат (например, "999/997_999") с объектами `Position`. Используется для быстрого доступа к информации о местоположении по координатам.
*   **`InvLocation (SortedDictionary<string, string>)`:** Обратный словарь для `Location`, сопоставляющий `RegNum` (например, "1-001") со строковым представлением координат. Позволяет быстро найти координаты по `RegNum`.
*   **`Cells (SortedDictionary<string, Cell>)`:** Словарь, хранящий объекты `Cell`, представляющие отдельные ячейки карты. Ключом является `CellNumber` (который совпадает с `RegNum`).
*   **`AbcCells (SortedDictionary<string, AbcCell>)`:** Словарь, хранящий объекты `AbcCell`, которые содержат дополнительную информацию о ячейках, специфичную для клиента (например, время последнего посещения).
*   **`MovableCells (SortedDictionary<string, string>)`:** (Назначение неясно из данного контекста, но, вероятно, связано с перемещаемыми объектами на карте).
*   **`Teleports (SortedList<string, string>)`:** Список телепортов, сопоставляющий `RegNum` телепорта с его названием.
*   **Статический конструктор:** Инициализирует все словари и списки, а также вызывает методы `LoadMap()`, `LoadAbcMap()`, `CompareMaps()`, `LoadTeleports()` для загрузки данных карты при запуске приложения.
*   **`AddRegion(string region, int xmin, int ymin)`:** Вспомогательный метод для инициализации регионов карты, заполняя `Location` и `InvLocation`.
*   **`LoadAbcMap()`:** Загружает данные о ячейках из `abcells.xml` в `AbcCells`. Обрабатывает информацию о стоимости, посещениях и верификации ячеек.
*   **`CompareMaps()`:** Сравнивает данные из `Cells` и `AbcCells`, удаляя устаревшие записи и добавляя новые.
*   **`LoadTeleports()`:** Загружает данные о телепортах из `abteleports.xml` в `Teleports`.
*   **`LoadMap()`:** Загружает основные данные карты из `map.xml` в `Cells`. Парсит информацию о стоимости, наличии рыбы/воды, группах трав, названиях и подсказках.
*   **`SaveAbcMap()`:** Сохраняет текущее состояние `AbcCells` обратно в `abcells.xml`.
*   **`ShowMiniMap(int xmove, int ymove)`:** Генерирует HTML-строку для отображения мини-карты. Использует `AppVars.Profile.MapShowMiniMap` и вызывает `ShowMap()`.
*   **`ShowMap(...)`:** Приватный метод, который строит HTML-таблицу для отображения карты, включая ячейки, ссылки и информацию о них. Обрабатывает границы мира и масштабирование.
*   **`AddCell(...)`:** Приватный вспомогательный метод для `ShowMap()`, который добавляет HTML-код для одной ячейки карты в `StringBuilder`. Включает логику отображения изображений, подсказок, информации о ботах и травах.
*   **`CellDivText(...)`:** Генерирует HTML-строку с подробной информацией о ячейке, включая ее номер, короткую метку, наличие рыбы/воды, ботов, трав и статус посещения. Использует `HexColorCost()` и `HexColorVisited()` для раскраски.
*   **`CellAltText(...)`:** Генерирует альтернативный текст для ячейки карты (используется для атрибута `alt` изображений), включая подсказки, информацию о ботах и травах.
*   **`ColorInterpolate(...)`:** Вспомогательные методы для интерполяции цветов.
*   **`ColorCost(int cost)`:** Возвращает объект `Color` в зависимости от стоимости перехода по ячейке.
*   **`ColorVisited(double hours)`:** Возвращает объект `Color` в зависимости от времени, прошедшего с момента посещения ячейки.
*   **`HexColorCost(int cost)`:** Преобразует `ColorCost` в шестнадцатеричную строку цвета.
*   **`HexColorVisited(double hours)`:** Преобразует `ColorVisited` в шестнадцатеричную строку цвета.
*   **`ConvertToRegNum(int x, int y)`:** Преобразует координаты в `RegNum`.
*   **`Move(string cur, int dx, int dy)`:** Вычисляет `RegNum` новой ячейки на основе текущей и смещения.
*   **`MakeRegNum(string reg, IFormattable k)`:** Форматирует `RegNum`.
*   **`MakePosition(int x, int y)`:** Форматирует строковое представление координат.
*   **`ResetAllVisitedCells()`:** Сбрасывает статус посещения для всех ячеек в `AbcCells`.

**Подробный анализ `IsCellInPath(int x, int y)`:**

```csharp
        internal static bool IsCellInPath(int x, int y)
        {
            var coor = MakePosition(x, y);
            if (!Location.ContainsKey(coor))
                return false;

            var regnum = Location[coor].RegNum;
            if (regnum == null)
                return false;

            return
                (AppVars.AutoMoving &&
                 AppVars.AutoMovingMapPath != null &&
                 AppVars.AutoMovingMapPath.Path.Length > 0 &&
                 Array.IndexOf(AppVars.AutoMovingMapPath.Path, regnum) >= 0);
        }
```

**Зависимости `IsCellInPath`:**

*   **`MakePosition(x, y)`:** Преобразует целочисленные координаты `x` и `y` в строковое представление (например, "999/997_999"). Уже портирован в `MapManager.kt`.
*   **`Location`:** Статическое свойство `Map`, представляющее `SortedDictionary<string, Position>`. Содержит информацию о всех известных местоположениях на карте. В Kotlin это `MapManager.locations: MutableMap<String, Position>`.
*   **`Position` класс:** Класс, содержащий `RegNum` (строковый идентификатор региона/ячейки), `X` и `Y` координаты. В Kotlin это `com.neverlands.anlc.data.model.map.Position`.
*   **`AppVars.AutoMoving`:** Статическая переменная `bool` в `AppVars.cs`. Флаг, указывающий, активно ли автоматическое перемещение. В Kotlin это `AppVars.autoMoving: Boolean`.
*   **`AppVars.AutoMovingMapPath`:** Статическая переменная, представляющая объект `MapPath`. Этот объект содержит рассчитанный путь для автоматического перемещения. **Это ключевая и сложная зависимость, требующая портирования всего класса `MapPath` и его алгоритма поиска пути.**
*   **`MapPath.Path`:** Свойство `MapPath`, представляющее `string[]` (массив строк), содержащий последовательность `RegNum` ячеек в рассчитанном пути.
*   **`MapPath.Path.Length`:** Свойство, возвращающее количество элементов в массиве `Path`.
*   **`Array.IndexOf(array, value)`:** Метод C#, который ищет `value` в `array` и возвращает индекс первого вхождения или -1, если не найдено. В Kotlin это эквивалентно `array.indexOf(value)`.

**Вывод по `IsCellInPath`:**
Полная и корректная реализация `isCellInPath` в Kotlin напрямую зависит от полного и точного портирования класса `MapPath` и всех его внутренних механизмов (алгоритм поиска пути, `MapPathNode`, обработка телепортов и городских ворот). Это очень объемная и сложная задача, которая должна быть выполнена до того, как `isCellInPath` сможет работать полноценно.
