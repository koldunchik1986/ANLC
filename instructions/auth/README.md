# Полная инструкция по авторизации: от Профиля до Игры

Это подробное руководство, которое объясняет весь путь, который проходит наше приложение, чтобы войти в игру. Мы разберем всё по шагам, как будто собираем конструктор.

---

## Часть 1: Профиль — Наше «Удостоверение личности»

Прежде чем войти в игру, нам нужно создать «удостоверение» — профиль. Это наша личность в мире Neverlands.

### Что такое профиль?

Это просто набор данных о пользователе:
*   **Логин:** Наше игровое имя.
*   **Зашифрованный пароль:** Наш игровой пароль, но не в открытом виде, а в виде секрета, который никто не сможет подсмотреть.
*   **Настройки:** Галочки, которые мы ставим в настройках (например, «чистить cookies при входе»).

### Как создается и хранится секрет (шифрование)?

Когда мы создаем профиль, мы придумываем **пароль от конфигурации**. Этот пароль — ключ от сейфа, в котором лежит наш настоящий игровой пароль.

1.  **`ProfileEditActivity.kt`:** Здесь мы вводим наш логин, игровой пароль и пароль от конфигурации.
2.  **`ProfileViewModel.kt`:** Он берет эти данные и передает их «мастеру по шифрованию».
3.  **`CryptoHelper.kt`:** Это наш «мастер». Он использует пароль от конфигурации, чтобы зашифровать игровой пароль с помощью магии `TripleDES`. Теперь игровой пароль превратился в абракадабру, которую без ключа (пароля от конфигурации) не прочитать.
4.  **`ProfileManager.kt`:** Сохраняет наш профиль со всеми данными, включая зашифрованный пароль, в специальный файл в памяти телефона.

**Зачем так сложно?** Это делается для безопасности. Даже если кто-то получит доступ к файлам приложения, он не сможет узнать наш игровой пароль, не зная пароля от конфигурации.

---

## Часть 2: Экран входа — «Проходная»

Теперь, когда у нас есть профиль, мы можем войти в игру.

1.  **`ProfilesActivity.kt`:** Это главный экран входа. Мы выбираем наш профиль из списка.
2.  **Запрос пароля:** Приложение просит нас ввести **пароль от конфигурации** (тот самый ключ от сейфа).
3.  **`ProfileViewModel.kt`:** Он передает профиль и введенный пароль от конфигурации в `AuthRepository`.

---

## Часть 3: Магия Авторизации — Секретный ритуал

Это самый важный и сложный этап. `AuthRepository` — наш главный «дипломат», который ведет переговоры с сервером игры. Он должен быть очень убедительным и действовать строго по правилам.

### Шаг 1: Подготовка к диалогу

*   **`AuthRepository`** сначала просит **`CryptoHelper`** открыть «сейф» с помощью нашего пароля от конфигурации и достать оттуда настоящий игровой пароль.
*   Если пароль от конфигурации верный, «сейф» открывается. Если нет — мы получаем ошибку.
*   Если в настройках профиля стоит галочка «чистить cookies», мы удаляем все старые «пропуска», чтобы не было путаницы.

### Шаг 2: Диалог с сервером (3-х ходовая комбинация)

Наш «дипломат» (`AuthRepository`) начинает диалог с сервером, используя «телефон» (`ApiClient`) и «переводчика» (`BrowserHeadersInterceptor`).

1.  **Первый ход: `GET /`**
    *   **Что делаем:** Отправляем вежливый запрос на главную страницу (`http://neverlands.ru/`).
    *   **Зачем:** Чтобы получить от сервера первый «пропуск-наклейку» (`watermark` cookie). Это показывает серверу, что мы — новый посетитель, и он готовит для нас сессию.

2.  **Второй ход: `POST /game.php`**
    *   **Что делаем:** Отправляем наш логин и расшифрованный игровой пароль.
    *   **Важные трюки:**
        *   **Маскировка:** Наш «переводчик» (`BrowserHeadersInterceptor`) добавляет к запросу заголовки, которые говорят: «Я — обычный браузер Chrome на Windows».
        *   **Секретный язык:** Он также следит, чтобы логин и пароль были написаны на «диалекте» `windows-1251`.
    *   **Зачем:** Сервер проверяет наши данные. Если всё верно, он выдает нам главный «ключ-пропуск» — новые, постоянные cookies сессии.

3.  **Третий ход: `GET /main.php`**
    *   **Что делаем:** Мы сразу же делаем запрос на страницу `/main.php`, показывая наш только что полученный «ключ-пропуск».
    *   **Зачем:** Это финальная проверка. Сервер видит наш ключ, понимает, что мы успешно вошли, и в ответ присылает нам самое ценное — HTML-код с игровым процессом.

### Шаг 3: Проверка результата

*   `AuthRepository` смотрит на полученный HTML-код. Если в нем есть слова `auth_form` или «неверный пароль», значит, что-то пошло не так, и мы получаем ошибку.
*   Если всё хорошо, `AuthRepository` говорит: «Успех! Вот HTML-код игры».

---

## Часть 4: Вход в Игровой Мир

1.  **`ProfilesActivity`** получает сигнал об успехе и HTML-код.
2.  Она запускает **`MainActivity`** (главный игровой экран) и передает ей этот HTML.
3.  **`MainActivity`** — это наш «телевизор». Она не загружает ничего из интернета сама, а просто берет готовый HTML-код и отображает его в `WebView` с помощью `loadDataWithBaseURL`. Это гарантирует, что мы видим именно ту страницу, которую получили после успешного входа.

Вот так, шаг за шагом, наше приложение проходит весь путь, чтобы мы могли наслаждаться игрой!