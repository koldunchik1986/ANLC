# Инструкция по авторизации персонажа Neverlands (Android)

## Ключевые принципы (строго по ПК-версии)

1. **Профиль**
   - Использовать структуру профиля: логин, пароль, опции (автоочистка cookies, автологин и т.д.).
   - Все параметры брать из ProfileManager.

2. **Cookie-jar**
   - Для каждого профиля — отдельное хранилище cookies (аналог CookieContainer).
   - После успешной авторизации сохранять только cookies, полученные при POST авторизации.
   - Для всех последующих запросов (main.php и т.д.) использовать только эти cookies.
   - Поддерживать опцию автоочистки cookies (очищать перед авторизацией, если включено).

3. **HTTP-запросы**
   - Все запросы делать через OkHttp с ручной установкой всех браузерных заголовков (User-Agent, Referer, Accept, Accept-Encoding, Accept-Language и т.д.).
   - Первый запрос — GET на http://neverlands.ru/ для получения watermark и стартовых cookies.
   - Второй запрос — POST на http://neverlands.ru/game.php с логином и паролем (кодировка windows-1251, Content-Type: application/x-www-form-urlencoded; charset=windows-1251).
   - После авторизации — GET main.php с только что полученными cookies.

4. **Кодировка**
   - Все параметры формы (логин, пароль) кодировать в windows-1251 (URLEncoder.encode(..., "windows-1251")).
   - Ответ main.php декодировать в windows-1251, поддерживать декомпрессию gzip.

5. **Логирование**
   - Вести подробный лог: все отправленные и полученные cookies, параметры, ответы сервера.
   - Лог писать в файл log.txt в internal storage приложения (через context.filesDir).

6. **Проверка результата**
   - Успех: main.php не содержит форму авторизации.
   - Ошибка: main.php содержит <form ... id="auth_form" ...> или "captcha".

7. **Потоки**
   - Все сетевые операции выполнять в IO-потоке (через coroutines).

---

## Минимальный алгоритм авторизации (Kotlin, Android)

1. (Опционально) Очистить cookies для профиля, если включено.
2. GET http://neverlands.ru/ (получить watermark и стартовые cookies).
3. POST http://neverlands.ru/game.php (логин, пароль, windows-1251, все заголовки, cookies).
4. Сохранить cookies, полученные после POST, для профиля.
5. GET main.php с этими cookies.
6. Проверить результат (форма/капча/успех).
7. Вести лог на каждом шаге.

---

## Пример вызова

```
AuthManager.authorizeAsync(login, password, callback, context)
```

---

## Важно
- Не использовать новые cookies, полученные после main.php, для следующих сессий — только те, что после авторизации.
- Строго соблюдать порядок и заголовки, как в HAR браузера.
- Все ошибки логировать.
